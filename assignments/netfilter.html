<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- If for some reason you are using IE, use edge -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- So bootstrap isn't horrible, set the width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">

  <title>Netfilter Kernel Module</title>

  <!-- Reference a CDN so this is properly cached in the browser forever. Unless they clean out the
       Cache this will incur no load time. Ideally we should put a security checksum but that breaks
       Firefox development sometimes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">

  <!-- Asynchronously load the code style sheet because we want everything loaded as fast as possible
       Also tag with ?v=time to bust the cache of any browser so updates appear -->
  <link async rel="stylesheet" href="/css/code-style.css?v='2019-01-16 13:38:19 -0600'">

  <!-- Don't load async because this will make the page render faster, plus the file is small.
       Also do the same cache busting magic here -->
  <link rel="stylesheet" href="/css/main.css?v='2019-01-16 13:38:19 -0600'">

</head>

<body>
<!-- Always shows a header, even in smaller screens. -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">

            <!-- Navigation button as html so we don't have to resize images -->
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>


            <!-- Inline tux for speed -->
            <a id="tuxlink"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAJCAMAAAA4jZ0cAAAAM1BMVEX///8CAgQMDAwsLCw0NDSjbQCkbQC+vbzOkwDU1NTlrADqvADxtgD0vQD12wD+/vz+//yBSdYEAAAAAXRSTlMAQObYZgAAADFJREFUCB0FwQkCQDAQBLCsq6g1/v9aCVQBthUwX8BIgStZCpUvKXSSLs6eyd0Pdg5+JwkBVyC74QYAAAAASUVORK5CYII=" title="Tux" alt="Tux" style="margin-left: 1em; width: 24px; filter: drop-shadow(1px 1px 0 white) drop-shadow(1px -1px 0 white) drop-shadow(-1px 1px 0 white) drop-shadow(-1px -1px 0 white); margin-top: 1em;"/></a>

            <a class="navbar-brand navbar-link normal" href="/">CS 241: System Programming</a>
            <a class="navbar-brand navbar-link small" href="/">CS 241</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            
            <li>
                <a class="navbar-link" href="/assignments.html">Assignments</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/quiz_topics.html">Quizzes</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/help.html">Help!</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/schedule.html">Schedule</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/honors.html">Honors</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/staff.html">The Crew</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/search.html">Search</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/coursebook/index.html">Coursebook</a>
            </li>
            
          </ul>
        </div>
        </div>
</nav>


<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 col-sm-1 col-xs-0"></div>
    <div class="col-md-8 col-sm-10 col-xs-12">
      <div class="wrapper">
        <div class="pad"><div class="card">
          <div class="title">
            <div class="speaker-wrapper">
              <button onclick="speak()" class="speaker" alt="Read Page"></button>
            </div>
            
            
            
            <h1>
              Netfilter Kernel Module

              
            </h1>
          </div>
          <div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
            
            
          </div></div></div>
        </div></div>
      </div>
      
      <div class="toc-wrapper">
<h4>Content</h4>
<ul class="toc"></ul>
</div>
      
      <div id="content">
          <div class="wrapper">


</div>
          <div class="wrapper">

<p>Requirements:</p>
<ul>
  <li>Understand how netfilter could be used to block packets</li>
  <li>Understand how the concepts you leared in CS 241 apply to the kernel</li>
  <li>Log incoming packets from google</li>
  <li>Have a proc endpoint to display how many times each of google’s IP ranges sent a packet</li>
  <li>Optional: Implement something extra (more statistics or some actual filtering)</li>
</ul>



<p>There’s two main components to making a kernel module, an initializer and an
exit handler. The initializer will run when the module is loaded and the exit
handler will run when the module is unloaded.</p>

<p>To accomplish this, either create two functions named <code class="highlighter-rouge"><a href="https://linux.die.net/man/2/init_module" class="fancy-link">init_module</a></code> and
<code class="highlighter-rouge">cleanup_module</code> or create two functions with any names (<code class="highlighter-rouge">foo</code> and <code class="highlighter-rouge"><a href="https://linux.die.net/man/1/bar" class="fancy-link">bar</a></code>) and
call <code class="highlighter-rouge">module_init</code> and <code class="highlighter-rouge">module_exit</code> on the initializer and exit handler
respectively (<code class="highlighter-rouge">module_init(foo)</code>, <code class="highlighter-rouge">module_init(bar)</code>).</p>

<p>Additionally, we will need to specify a module license (you don’t have to, but
the compiler will warn you if you don’t). We’ll stick to GPL, so include the
line:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MODULE_LICENSE("GPL");
</code></pre></div></div>
<p>in your code.</p>

<p>Since it is cumbersome to use debuggers with kernel modules (there are kernel
debuggers, but we won’t use them today), we will rely on logging for outputing
debug info. Unlike with a normal program, you do not have a stdout/stdin channel
so there is no way to have a “default” output stream for non-logging purposes.
To log information you will use <code class="highlighter-rouge">printk</code> (It works almost exactly like
<code class="highlighter-rouge"><a href="https://linux.die.net/man/3/printf" class="fancy-link">printf</a></code>). To view the log either view the contents of files in <code class="highlighter-rouge">/var/log</code> or
use the program <code class="highlighter-rouge"><a href="https://linux.die.net/man/1/dmesg" class="fancy-link">dmesg</a></code>. I prefer to use <code class="highlighter-rouge">dmesg -wH</code> since that shows a stream
of output with human readable timestamps.</p>

<p>To complete part 1, write a kernel module in <code class="highlighter-rouge">filter.c</code> and using <code class="highlighter-rouge">printk</code> write
“hello world” to the log.</p>



<p>In this part we will experiment with <code class="highlighter-rouge">netfilter</code> - a way of filtering packets at
the kernel level. To accomplish this, we’ll need to setup a few things.</p>

<p>We’ll need a global variable to keep track of our netfilter options, we’ll need
to initialize those options in our <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/init" class="fancy-link">init</a></code> callback, and finally, we’ll need to
register/unregister our netfilter hook at <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/init" class="fancy-link">init</a></code>/<code class="highlighter-rouge"><a href="https://linux.die.net/man/3/exit" class="fancy-link">exit</a></code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// global:
static struct nf_hook_ops netfilter_ops;

// in init
  netfilter_ops.hook = main_hook; // What is main_hook?
  netfilter_ops.pf = PF_INET;
  netfilter_ops.hooknum = 0; // We want to run the hook before routing packets
  // We want this hook to run before other currently installed hooks
  netfilter_ops.priority = NF_IP_PRI_FIRST;
  //                    v init_net is a variable exported by the netfilter header
  nf_register_net_hook(&amp;init_net, &amp;netfilter_ops); // register the hook

// in exit
nf_unregister_net_hook(&amp;init_net, &amp;netfilter_ops); // unregister the hook
</code></pre></div></div>

<p>These options will create a netfilter that will filter incoming packets. You can
find details online about how to filter outbound packets.</p>

<p>In this example <code class="highlighter-rouge">main_hook</code> is the function that actually implements the
functionality of the module. More generally, it needs to be a function with the
following signature:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static unsigned int main_hook(void *priv, struct sk_buff *skb,
                              const struct nf_hook_state *state);
</code></pre></div></div>

<p>The static isn’t strictly necessary, but it’s good practice to declare
everything in your module as static besides your init and cleanup.</p>

<p>The only parameter we’ll be using is <code class="highlighter-rouge">skb</code>. We want to extract the source ip of
packets we are recieving. You can do that with the following lines of code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  struct iphdr *ip_header = (struct iphdr *)skb_network_header(skb);
  unsigned int src_ip = (unsigned int)ip_header-&gt;saddr;
</code></pre></div></div>

<p>Using the google ranges provided in <code class="highlighter-rouge">filter.h</code> find the index of the range the
incoming packet belongs to and log it. If you’d like to also view the human
readable ip in your log, use the format specifier <code class="highlighter-rouge">%pI4</code> in <code class="highlighter-rouge">printk</code> and pass in
a pointer to the ip address.</p>

<p>Finally you’ll want to return <code class="highlighter-rouge">NF_ACCEPT</code> to allow the packet to continue on
it’s journey through the network stack. If you wanted to block the packet
instead, use <code class="highlighter-rouge">NF_DROP</code>. Try playing around with those options to block specific
google ranges.</p>

<p>To test this, run <code class="highlighter-rouge">dmesg -wH</code> in one terminal and in other try commands like:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ping www.google.com
wget google.com &amp;&amp; rm index.html
ping [ something that isn't owned by google ]
</code></pre></div></div>

<p>and check your <code class="highlighter-rouge"><a href="https://linux.die.net/man/1/dmesg" class="fancy-link">dmesg</a></code> log for updates.</p>



<p>Now, we’re going to create an endpoint in <code class="highlighter-rouge">/proc</code> that will allow you to view
statistics about the packets you’ve intercepted. To accomplish this, create a
global array that will store in the <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/i" class="fancy-link">i</a></code>th index, the number of times the <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/i" class="fancy-link">i</a></code>th
range sent a packet.</p>

<p>In order to prevent race conditions, we’ll need to lock access to this array.
While there are spinlocks in the kernel, we’ll be using a mutex today for
learning purposes.</p>

<p>You’ll need to create a mutex with <code class="highlighter-rouge">mutex_init</code> and destroy it with
<code class="highlighter-rouge">mutex_destroy</code>. Locking and unlocking are provided by <code class="highlighter-rouge">mutex_(un)lock</code>.</p>

<p>Revise the lecture slides for more info about how to use a mutex in the kernel
and how that is different from a spinlock.</p>

<p>To create your proc endpoint, you can use the following code:</p>



<p>Here is some sample code for implementing read. In this code, <code class="highlighter-rouge">range_count</code> is
an array of <code class="highlighter-rouge">size_t</code>s such that the <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/i" class="fancy-link">i</a></code>th element of the array contains the
number of packets recieved from range <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/i" class="fancy-link">i</a></code>.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static char message[1024];
ssize_t filter_read(struct file *f, char __user *u, size_t req, loff_t *off) {
  int message_offset;
  int i;

  message_offset = 0;
  mutex_lock(&amp;range_count_mutex);
  for (i = 0; i &lt; google_range_count; i++) {
    message_offset +=
        snprintf(message + message_offset, sizeof(message) - message_offset,
                 "range %d (%pI4 - %pI4): %zu\n", i, google_ranges[i].start,
                 google_ranges[i].end, range_count[i]);
    if(message_offset &gt;= 1024)
      break;
  }
  mutex_unlock(&amp;range_count_mutex);

  if (*off &gt; message_offset)
    return 0;
  if(req &gt; message_offset - *off)
    req = message_offset - *off;

  copy_to_user(u, message+*off, req);
  *off += req;
  return req;
}
struct file_operations fops = {
    .read = filter_read,
};

struct proc_dir_entry *filterdir;

// in init
  filterdir = proc_mkdir(filter", NULL); // Creates  /proc/filter/
  proc_create("status", 0666, filterdir, &amp;fops); // creates /proc/filter/status
// in exit
  remove_proc_entry("status", filterdir);
  remove_proc_entry("filter", NULL);

</code></pre></div></div>

<p>Try experimenting with write. Maybe enable or disable the filter with a write to
a proc endpoint or try allowing a user to add in new ranges.</p>
</div>
          
          <div class="wrapper">
</div>
      </div>
      <div class="col-md-2 col-sm-1 col-xs-0"></div>
    </div>
  </div>
  <script>
    var github_repo = "illinois-cs241/illinois-cs241.github.io";
    var github_path = "_docs/netfilter.md";
  </script>
  <!-- Mathjax takes a while to load so do a lazy load to so we can get accessibility -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script>

<!-- Bring in JQuery and Bootstrap -->
<script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>

<!-- Again bust cache on the main.js file -->
<script src="/js/main.js?v='2019-01-16 13:38:19 -0600'"></script>

<footer class="">

<div class="container-fluid">
<div class="shadow"></div>

</div>

</footer>

</body>
</html>
